https://ke.qq.com/webcourse/index.html#cid=449938&term_id=103762638&taid=11532957852818834&type=1024&vid=5285890793164766606



alpine 发行版

    非常轻型的 Linux 发行版

    基于 Alpine 构造的镜像只有5M

    但是有完整的包管理器


### 内核名称

主版本号.次版本号.发布版本-修改版本

主版本号

次版本号

    一般是指有重要功能新增，但是不影响API的兼容性

发布版本号

    修复原有功能的bug


网卡 ONBOOT=YES, 都会读这些配置文件, 开机时是否启动
    
    可能有多块网卡, 一般不用 systemctl restart network


tab 命令补全:
    注意看当已经找到时, 当前光标之前会有一个空格
    还有多个选项时是没有空格的



## 命令

1. hostid - print the numeric identifier for the current host

1. history
    ~/.zsh_history

    -n  显示最近的n条历史命令
    -d  NUM, 删除某条历史命令
    -c
    -w
    -r
    
    退出终端时写入

1. hostname
    /etc/hostname
    /etc/hosts

1. hostnamectl

    hostnamectl set-hostname

    hostnamectl status
        
        ```
        Static hostname: bpc
        Icon name: computer-desktop
        Chassis: desktop
        Machine ID: de7690c17f8a4496b7384b63fe9592de
        Boot ID: 402e69d807af4fda952b47a5f858fd57
        Operating System: Debian GNU/Linux 10 (buster)
        Kernel: Linux 4.19.0-17-amd64
        Architecture: x86-64
        ```

1. ls

1. pwd

    -L, --logical
        use PWD from environment, even if it contains symlinks

    -P, --physical
        avoid all symlinks

1. cat

1. echo 
    -n     do not output the trailing newline           不换行
        ```
        ➜  ~ echo lk        // 最后有一个\n
        lk
        ➜  ~ echo -n lk     // 没有\n
        lk# 
        ```
    -e     enable interpretation of backslash escapes
    -E     disable interpretation of backslash escapes (default)


1. shutdown

    -H, --halt
        Halt the machine.
    -P, --poweroff
        Power-off the machine (the default).
    -h
        Equivalent to --poweroff, unless --halt is specified.

1. file

1. date
    %u     day of week (1..7); 1 is Monday

    date [OPTION]... [+FORMAT]
    date [-u|--utc|--universal] [MMDDhhmm[[CC]YY][.ss]]


1. hwclock
    clock 是软连接执行hwclock
    --hctosys
    --systohc

1. which
    -a     print all matching pathnames of each argument

    去掉 alias 
        --skip-alias        // 没有这个啊

        https://unix.stackexchange.com/questions/10525/how-to-use-which-on-an-aliased-command
        
        使用 builtin command: type

1. who

    -u, --users
        list users logged in

1. w

    user   Show information about the specified user only.

1. tree

    -L level
        Max display depth of the directory tree.
        ls 能看到的就是第一层

1. less

    -N or --LINE-NUMBERS
        Causes a line number to be displayed at the beginning of each line in the display.

1. stat
    
1. touch

    -c, --no-create
        do not create any files

    -d, --date=STRING
            parse STRING and use it instead of current time
    
    -a     change only the access time

    -m     change only the modification time








## /etc/sysconfig/network-scripts/ifcfg-

PROXY_METHOD=none       // 代理方式
BROWSER_ONLY=no         //
BOOTPROTO=no/static     // 静态
    BOOTPROTO=none      //启动地址协议=无（启动是不使用任何协议）
    BOOTPROTO=bootp     //启动地址协议=使用bootp协议
    BOOTPROTO=dhcp      //启动地址协议=使用dhcp协议
    BOOTPROTO=static    //启动地址协议=使用static（静态地址）协议
DEFROUTE=yes            // 静态路由
NAME=
DEVICE=

IPADDR=
PREFIX=24
    NETMASK=255.255.255.0
GATEWAY=


/etc/resolv.conf
    立即生效    // Generated by NetworkManager
    dhcp时会自动写入到该文件

    /etc/sysconfig/networ-scripts/ifcfg- 中的 DNS1 会覆盖 /etc/resolv.conf 中的地址
    systemctl restart network 生效, 开始覆盖 /etc/resolv.conf

    如何禁止覆盖 /etc/resolv.conf
        1. network active , networkmanager inactive
            ifcfg文件加入  PEERDNS=no
        2. network inactive, networmanager active   || 只要 NetWorkManager active
            /etc/NetWorkManager/NetWorkManager.conf   添加 dns=no




## 文件系统及项目实战

|               +-----------------------+
|               |   User applications   |
|               +-----------------------+
|                   |               |
|                   |           +---------------+
|                   |           | GNU C Library |
|                   |           +---------------+
|                   |               |
|               +-----------------------+
|               | System call interface |
|               +-----------------------+
|                            |
|                            |
| +-----------+   +-----------------------+  +-----------------+
| |Inode Cache|   | Virtual File System   |  | Directory Cache |
| +-----------+   +-----------------------+  +-----------------+
|                            |
|                            |
|               +------------------------+
|               | Individual file system |
|               +------------------------+
|                            |
|                            |
|               +-----------------------+
|               |     Buffer cache      |
|               +-----------------------+
|                            |
|                            |
|               +-----------------------+
|               |     Device Drivers    |
|               +-----------------------+


超级块, inode, 文件, 目录



查看 inode 

    df -hi

    mv 时, 在同一个文件系统中, inode 不变, 所以速度要快

    find .  -samefile
        
        -samefile name
            
            File refers to the same inode as name.  When -L is in effect, this
            can include symbolic links.


/lib
/usr/lib

/proc
    方法一:
        sysctl -a | grep icmp
        
        vi /etc/sysctl.conf
        
            net.ipv4.icmp_echo_ignore_all = 1
            
        sysctl --load

    方法二:
        cat /proc/sys/net/ipv4/icmp_echo_ignore_all


/var/run -> /run

/usr
    /include


mke2fs


df -hiT

```消耗掉所有 inode
#!/usr/bin/bash ¬
¬
for ((i=1;;i++));do¬
    if [ $? -eq 0  ];then¬
        echo "inode num is: $i" > inode${i}.txt¬
    else¬
         exit¬
     fi¬
 done¬
```

但是还可以创建硬链接


### 硬盘

IDE(Integrated Drive Electronics) 也被称为PATA(并行ATA), 133MB/s

SCSI 并行接口, 640MB/s

SATA: 串型接口, 相当于IDE的串型升级, 支持热插拔

    SATA2.0协议开始允许热插拔，多年前在售的硬盘和主板，应该都是SATA2.0或以上的
    了，所以实现热插拔是完全没有问题的了，BIOS里设置以下两项即可实现：

    1.硬盘模式设置为AICH
    2.对应的硬盘端口设置为hot plug

SAS: 相当于 SCSI 的串型升级版, 支持热插拔


USB
    USB1.0 : 1.5Mb/s，
    USB2.0 : 480Mbps
    USB3.0 : 4Gb/s
    USB 3.1: 10Gb/s。

### 并行和串行数据传输哪个快？

根据我们日常经验，我们可能会觉得并行更快，就像高速公路上4车道肯定要快于1车道，
但是实际情况是，如果要保证4车道安全稳定运行，必须限制每个车道的速度，因为到达一
定速度之后，车辆互相之间稍微一点影响就可能导致严重的灾难，所以我们必须想方设法
保证之间互不干扰。但是想象一下，如果存在一条超级高速（当然，也不用限速），车辆
互相之间不存在干扰，速度可以轻松得到提高，那么高到一定程度后就会比4车道单位时间
里经过的车辆更多。

而其实在数据流传输中，传输速度很容易得到提高，但是电子信号的干扰很难解决。一个
时钟周期，由于并行数据传输过程中存在的信号干扰、相差所导致的数据采样问题，并行
传输无法提高时钟频率。而采用低压差分串行传输过程中，不存在采样相位差问题，可以
采用非常高的时钟频率进行数据传输，因此串行传输的性能要远高于并行传输。串行数据
传输的发展解决了并行总线所存在的信号干扰等问题，因此，在2000年以后，在ATA的基础
上发展形成了SATA；在SCSI基础之上发展形成SAS。



现在的磁盘一个物理扇区是4Kbyte

head 磁头
    0磁头

track 磁道

cylinder 柱面
    0磁道

    同一个柱面进行操作会更快, 电器特性, 所以是按柱面来的, 所有盘片的同一个磁道,
    而不是一个磁盘写满在写另一个磁盘

sector 扇区
    1扇区

### 为什么数据读写或者分区其实是按柱面进行的？

数据的读/写按柱面进行，即磁头读/写数据时首先在同一柱面内从“0”磁头开始进行操作，
依次向下在同一柱面的不同盘面即磁头上进行操作，只在同一柱面所有的磁头全部读/写完
毕后磁头才转移到下一柱面，因为选取磁头只需通过电子切换即可，而选取柱面则必须通
过机械切换。电子切换相当快，比在机械上磁头向邻近磁道移动快得多，所以，数据的读/
写按柱面进行，而不按盘面进行。也就是说，一个磁道写满数据后，就在同一柱面的下一
个盘面来写，一个柱面写满后，才移到下一个柱面的某个扇区开始写数据。读数据也按照
这种方式进行，这样就提高了硬盘的读/写效率。

### 磁盘的容量 =  磁头数 × 磁道(柱面)数 × 每道扇区数 × 每扇区字节数

通过上面的磁盘结构解读，我们很容易理解数据的读取或者写入速度取决于移动到磁盘相
应的位置，这里有几个参数名词：

1. 寻道时间：磁头从开始移动到数据所在磁道所需要的时间，寻道时间越短，I/O操作越快，
目前磁盘的平均寻道时间一般在3－15ms，一般都在10ms左右。

1. 旋转延迟：盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间，旋转延迟取决
于磁盘转速。

1. 数据传输时间：是指完成传输所请求的数据所需要的时间，它取决于数据传输率，其值等
于数据大小除以数据传输率。目前IDE/ATA能达到133MB/s，SATA III可达到6Gb/s的接口数
据传输率，数据传输时间通常远小于前两部分消耗时间，因此我们在计算磁盘性能时，这
个时间几乎可以忽略不计。

机械硬盘的连续读写性能很好，但随机读写性能很差，这主要是因为磁头移动到正确的磁
道上需要时间，随机读写时，磁头需要不停的移动，时间都浪费在了磁头寻址上，所以性
能不高。衡量磁盘的重要主要指标是IOPS和吞吐量。

1. 硬盘转速：磁盘一分钟能完成多少次旋转。早期是 5400rpm，后来达到 7200rpm，现在有
些磁盘转速已经达到10000rpm、15000rpm（当然，这么高的转速对环境要求非常高，所以
硬盘内部是真空结构的）。


### 磁盘分类与性能衡量指标

我们根据磁盘制作工艺，可以简单的将磁盘分为 机械硬盘 和 固态硬盘，机械硬盘是机械
设备；固态硬盘是电子或者说是电气设备，两者在数据的写入和读取速度上几乎不可同日
而语。

我们衡量硬盘性能的关键指标主要有两个

1. IOPS（Input/Output Per Second）

    即磁盘每秒能够完成的随机读写次数，随机读写频繁的应用，如小文件存储等，关注
    随机读写性能，IOPS是关键衡量指标。可以推算出磁盘的

    IOPS = 1000ms / (Tseek + Trotation + Transfer)，

    如果忽略数据传输时间，理论上可以计算出随机读写最大的IOPS。常见磁盘的随机读写最大IOPS为：

    1. 7200rpm的磁盘 IOPS = 76 IOPS 
    1. 10000rpm的磁盘IOPS = 111 IOPS 
    1. 15000rpm的磁盘IOPS = 166 IOPS
    1. 而固态硬盘（三星 830系列 128G 2.5英寸 SATA-3固态硬盘(MZ-7PC128B/WW)）：随机
        读取最大 80,000 IOPS ，随机写入最大 30,000 IOPS据称：

Microsemi（美高森美） 宣布 2019 年发布支持PCIe 4.0的SSD将实现 8GB/s、2000,000 IOPS。

虽然15000rpm的磁盘计算出的理论最大IOPS仅为166，但在实际运行环境中，实际磁盘的
IOPS往往能够突破200甚至更高。这其实就是在系统调用过程中，操作系统进行了一系列的
优化。

1. 吞吐量（Throughput）

    指单位时间内可以成功传输的数据数量。

    小文件的查看的关键（监控）指标是 IOPS，那么大文件的关键（监控）指标主要查看
    吞吐量。


### 磁盘分区

```
typedef struct {
    char    bootinst[446];   /* space to hold actual boot code */
    mbr_table partitions[4];
    unsigned short  signature;/* set to 0xAA55 to indicate PC MBR format */
} mbr_head;
```

|           N个扇区的硬盘, 每个山区512字节
|
|           +------------------+-----------+---+-------+
|           | 0扇区, 主引导记录|1扇区|2扇区|...|N-1扇区|
|           +------------------+-----------+---+-------+
|
|
|   主引导记录(512字节)
|                                                                                                   0xAA55
|   +-----------------------+-----------------+-----------+------------------------------------+----------------+
|   | 引导程序代码(440Byte) | 硬盘签名(4Byte) | 空(2Byte) | 分区表(4个16字节的条目,总共64字节) | MBR签名(2字节) |
|   +-----------------------+-----------------+-----------+------------------------------------+----------------+
|
|
|   MBR 结构图
|
|   +-----------------------+       +-------------------+           +--------------------+
|   | 引导程序，引导启动OS  |       |                   |           | 引导标记1Byte      |
|   | 446Bytes              |       | 分区表1, 16Bytes  |-------->  +--------------------+
|   |                       |       |                   |           | CHS开始位置 3Bytes |
|   +-----------------------+       +-------------------+           +--------------------+
|   |                       |       |                   |           | 分区类型 1Byte     |
|   | 分区表 64Bytes        |---->  | 分区表2, 16Bytes  |           +--------------------+
|   |                       |       +-------------------+           | CHS结束位置 3Bytes |
|   +-----------------------+       | 分区表3, 16Bytes  |           +--------------------+
|   |                       |       +-------------------+           | 起始扇区 4Bytes    |
|   | 有效标识符 2Byte      |       | 分区表4, 16Bytes  |           +--------------------+
|   |                       |       |                   |           | 扇区大小 4Bytes    |  2^31=2T
|   +-----------------------+       +-------------------+           +--------------------+
|



## fdisk

fdisk /dev/sdb

n   add a new partition
t   change a partition's system id

cat /proc/partitions 或者 fdisk -l


通知内核()
    partprobe
    partx
        partx -a /dev/sdb

blkid

    mkfs.ext4 -L "卷标名称" /dev/sdb5


tune2fs
    ext系列
    tune2fs -L 卷标名称 /dev/sdb1


xfs_admin
    xfs系列
    xfs_admin -L 卷标名称 /dev/sdb2

export LANG=en  即可临时改变为 英文


fuser -v /mnt
    不能使用 /dev/sdb1

lsof /dev/sdb1
    比 fuser 更清晰


## 逻辑卷

Logical Volume Management（当前我们 CentOS6、7 上使用的都是version2）是指把物理
磁盘和分区抽象到更高的层次形成存储介质。


|           Volume Group0
|   +---------------+-------+------------------------+-----------------------+
|   |sda1 sda2 sda3 |       |  sdb                   |  sdc                  |
|   +---------------+-------+------------------------+-----------------------+
|   Physical disk 0         | Physical disk1         |   Physical disk 2
|

逻辑卷在生产环境中主要解决两大问题：

    1. 磁盘在线扩展

    1. 快照备份


### 逻辑卷管理实现原理

在实现逻辑卷管理 LVM 中，有三个组成元素，分别是 

    1. 卷（Volume）、

    1. 区段（Extent）、

    1. LVM 设备驱动（也称为 设备映射器 Device mapper ，Linux 内核模块，用于完成
       LVM 的驱动管理）。


1. Volume

    可以分成
    物理卷（Physical Volume，简称 PV）
    卷组（Volume Group，简称 VG）
    逻辑卷（Logical Volume，简称 LV）。

|   +-------------------------------------------+----------------------------+
|   |   ext4                                    |                            |
|   +-------------------------------------------+----------------------------+
|   | Logical Volume 0                          | Free Space                 |
|   +-------------------------------------------+----------------------------+
|   | Volume Group 0                                                         |
|   +---------------+-------+------------------------+-----------------------+
|   |sda1 sda2 sda3 |       |  sdb                   |  sdc                  |
|   +---------------+-------+------------------------+-----------------------+
|   Physical disk 0         | Physical disk1         |   Physical disk 2
|


底层的物理硬盘（或者分区），如 /dev/sda1 或者 /dev/sdb 就是物理卷，但其实准确的
说需要对物理卷进行初始化（比如设定物理卷名称、大小、UUID等信息）之后才能被卷组
使用。

卷组就是物理卷的集合，卷组可以由一个或者多个物理卷组成，那么卷组的大小就等于物
理卷大小之和。

我们在卷组上划分出指定大小的逻辑空间称为逻辑卷。


LVM 也需要通过内核模块完成设备映射，这个模块叫做 dm_mod

    lsmod | grep dm_mod             (device mapper)
    lsmod | grep sd_mod             // SCSI 接口的设备驱动叫做 sd_mod 
    modinfo dm_mod

    ```
    ➜  /etc df -h
    Filesystem                Size  Used Avail Use% Mounted on
    udev                       16G     0   16G   0% /dev
    tmpfs                     3.2G  9.2M  3.2G   1% /run
    /dev/mapper/bpc--vg-root  218G   65G  143G  32% /                       // 卷组-逻辑卷(centos-root, centos-swap)
    tmpfs                      16G  1.1G   15G   7% /dev/shm
    tmpfs                     5.0M  4.0K  5.0M   1% /run/lock
    tmpfs                      16G     0   16G   0% /sys/fs/cgroup
    /dev/sda1                 472M   85M  363M  19% /boot
    overlay                   218G   65G  143G  32% /var/lib/docker/overlay2/1673af634c85f9e40fe12a03734bc7592a66383ae719addee3818ad58a2cf488/merged
    tmpfs                     3.2G   40K  3.2G   1% /run/user/0
    ➜  /etc ll /dev/dm-0
    brw-rw---- 1 root disk 254, 0 Aug  4 22:12 /dev/dm-0
    ➜  /etc ll /dev/mapper/bpc--vg-root
    lrwxrwxrwx 1 root root 7 Aug  4 22:12 /dev/mapper/bpc--vg-root -> ../dm-0
    ➜  /etc ll /dev/mapper/bpc--vg-swap_1
    lrwxrwxrwx 1 root root 7 Aug  4 22:12 /dev/mapper/bpc--vg-swap_1 -> ../dm-1
    ```

    1. /dev/mapper/home     链接文件
    2. /dev/卷组/home       链接文件
    3. /dev/dm-0            真实文件


### 逻辑卷扩展 

1. 一般要先对物理硬盘作分区
    fdisk /dev/sdb

2. 创建物理卷

    pvcreate /dev/sdb1
    pvcreate /dev/sdb5

    pvs                 // Display information about physical volumes
    pvscan
    pvdisplay
        pvdisplay /dev/sdb1

    ---

    vgcreate 卷组名  物理卷1 物理卷2 ...

    vgcreate MYVG01 /dev/sdb1 /dev/sdb5

    vggdisplay 

    ---

    lvcreate -n 名称 -p 属性 -L 逻辑卷大小 -s 创建逻辑卷快照

    lvcreate -n MYLV0  -L  1.5G  MYVG01

    lvdisplay 

    ```
    --- Logical volume ---
    LV Path                /dev/MYVG01/MYLV01               
    LV Name                MYLV01
    VG Name                MYVG01
    LV UUID                My2TWs-MM1e-wqwA-JPks-SvgL-Q1a7-ZElCOy
    LV Write Access        read/write
    LV Creation host, time centos7-clone1, 2021-08-08 10:43:09 -0400
    LV Status              available
    # open                 0
    LV Size                1.50 GiB
    Current LE             384
    Segments               1
    Allocation             inherit
    Read ahead sectors     auto
    - currently set to     8192
    Block device           253:2

    ```

3. 文件系统

    mkfs.ext4 -L MyLV01 /dev/mapper/MYVG01-MYLV01

    fdisk -l 

    mount /dev/mapper/MYVG01-MYLV01 /mnt

### 扩展

从下向上

lvextend -L +0.5G /dev/mapper/MYVG01-MYLV01
lvextend -L 2G /dev/mapper/MYVG01-MYLV01

umount /mnt

resize2fs  /dev/mapper/MYVG01-MYLV01

--- 添加物理卷

pvcreate  /dev/sdb6
vgextend  MYVG01 /dev/sdb6
lvextend  -L +4G /dev/mapper/MYVG01-MYLV01



### 逻辑卷缩减

从上向下

ext4文件系统不支持在线缩减, 所以首先要卸载

    umount /mnt

e2fsck -f /dev/mapper/MYVG01-MYLV01

resize2fs  /dev/mapper/MYVG01-MYLV01 1.5G
(xfs 不支持缩减, 要备份出来再做操作)

lvreduce -L 1.6G /dev/mapper/MYVG01-MYLV01

mount /dev/mapper/MYVG01-MYLV01 /mnt

#### 删除物理卷

pvdisplay -m /dev/sdb6
    -m|--maps
    
    Allocated PE          765

pvchange -xn /dev/sdb6
    -x|--allocatable y|n        //是否还可以分配, -xn: 不可以分配

pvmove -i 5 /dev/sdb6

vgreduce  卷组名  物理卷
    vgreduce MYVG01 /dev/sdb6

pvremove /dev/sdb6


### 快照

所谓 快照，就相当于对逻辑卷某个时刻上面的内容拍摄的一张照片，通过快照功能可以实
现对同一个逻辑卷的两份拷贝，一份用于生产，一份用于备份。注意，这里的用于备份拷
贝并不是数据内容的拷贝，而是类似对所有数据做了一个**硬链接**，通过这个硬链接我们就
可以访问原来的数据内容，也就是说在创建完快照之后，快照卷里最初只有逻辑卷中文件
的硬链接内容。除此之外，快照功能实现了类似数据监听功能，能够发现哪些文件发生了
修改，把修改之前数据内容拷贝到快照卷中（即 CoW：Copy-on-Write）。这样，未发生变
化的数据可以通过硬链接的方式访问，而变化的内容就会存放在原文件在快照卷中，所以
快照卷中存放的是变化的文件。



lvcreate -s -n MYLV01-SNAP -L 5G -p r /dev/mapper/MYVG01-MYLV01

    -s|--snapshot

mount /dev/MYVG01/MYLV01-SNAP /mnt

#### 快照的删除

umount /mnt

lvremove /dev/MYVG01/MYLV01-SNAP

vgremove 

pvremove
