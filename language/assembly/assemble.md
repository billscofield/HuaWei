
MASM (the Microsoft Macro Assembler) 

## 汇编语言

汇编语言由以下3类组成

    1. 汇编指令 (机器码的助记符, 有对应的机器码)

    1. 伪指令   (没有对应的机器码，由编译器执行,计算机并不执行)
        编译器用的一些命令

    1. 其他符号, 如 + - x / 等(由编译器识别,没有对应的机器码)


CPU 要想运作，就需要指令和数据，指令和数据在存储器中存放，也就是内存

指令和数据是应用上的概念;在内存或磁盘上，**指令和数据没有任何区别，都是二进制信息，
关键在于如何解释**

一段二进制是指令还是数据由我们说了算


## 存储单元

存储器被划分为若干个存储单元，每一个存储单元从 0 开始顺序编号, 例如:

    一个存储器有128个存储单元，编号 [0,127]

存储单元的单位是 Byte

一个存储单元是 1Byte


## cpu 对存储器的读写

这里的存储器包括内存、显存等

1. 存储单元的地址   (地址信息)      地址
1. 读或写命令       (控制信息)      控制
1. 读或写的数据     (数据信息)      数据


在计算机中连接 CPU 和其他芯片的导线，叫做 总线

    在物理上: 一根根导线的集合

    在逻辑上:
        地址总线(AB)
        数据总线(DB)
        控制总线(CB)

    同一段二进制，在地址总线中就是地址；在数据总线中就是数据；在控制总线中就是控制语句


### 地址总线(Address Bus, AB)

CPU 是通过地址总线来制定存储单元的

地址总线上能传送多少个不同的信息，CPU 就可以对多少个存储单元进行寻址

一个CPU有N根地址线，则可以说这个CPU的地址总线的宽度为N



+-------+--------------+-------------+-------------------------------+-------------------------+
| CPU   | 地址总线宽度 | 寻址能力    | 数据总线宽度 | 一次传输数据量 | 读取 1KB 数据要读多少次 |
+-------+--------------+-------------+-------------------------------+-------------------------+
| 8080  | 16bits       | 64KB        | 8            | 1Byte          |                         |
| 8088  | 20bits       | 1MB         | 8            | 1Byte          |                         |
| 8086  | 20bits       | 1MB         | 16           | 2Byte          | 2^10/2 = 512            |
| 80286 | 24bits       | 16MB        | 16           | 2Byte          |                         |
| 80386 | 32bits       | 2^32=4GByte | 32           | 4Byte          |                         |
+-------+--------------+-------------+-------------------------------+-------------------------+

8086 读取1024字节的数据，需要读512次



上低位下高位
    
    +---+       +----+
    | 1 |       | 内 |
地  | 1 |       |    |
    | 0 |       |    |
址  | 1 |  -->  |    |      1011
    | 0 |       |    |
总  | 0 |       | 存 |
    | 0 |       |    |
线  | 0 |       |    |
    +---+       +----+

数据总线        

控制总线


一个 CPU 有 N 根地址总线，则可以说这个 CPU 的地址总线的宽度为 N

这样的 CPU 最多可以寻址 2 的 N 次方个内存单元


### 数据总线

数据总线的宽度决定了 CPU 和外接的数据传送速度

数据总线DB用于传送数据信息。

数据总线是双向三态形式的总线，
    1. 即他既可以把CPU的数据传送到存储器或I／O接口等其它部件，
    2. 也可以将其它部件的数据传送到CPU。

8088CPU的数据总线宽度为8

8086CPU的数据总线宽度为16


### 控制总线

控制总线是一些不同控制线的集合

有多少根控制总线，就意味着 CPU 提供了对外部器件的多少种控制, 要么读，要么写，一根就够了

所以，控制总线的宽度

### CPU 对外围设备的控制

CPU 对外部设备都不能直接控制，直接控制这些设备进行工作的是插在扩展插槽上的接口卡。

扩展插槽通过总线和CPU相连，所以扩展卡也通过总线和CPU相连.

**CPU 可以直接控制这些接口卡，从而实现 CPU 对外设的间接控制**

### 各类存储器

读写属性上分
    随机存储器RAM 只读存储器ROM

从功能和连接上
    随机存储器 RAM
    装有BIOS的 ROM
    接口卡上的 RAM

不光主板，显卡，网卡上都有 BIOS

各种存储器在逻辑上组成一个逻辑存储器，CPU 将其作为一个整体来看待


RAM
    主板上的RAM
    扩展插槽上的RAM(例如显卡)

ROM
    系统BIOS
    接口卡上的BIOS


## 寄存器

在16进制表示的数据后面加 H
在2进制表示的数据后面加 B
在10进制表示的数据后面什么也不加

[link](http://www.elecfans.com/baike/zhujipeijian/cpu/20180416662703_a.html)

一个典型的 CPU 由运算器、控制器、寄存器等器件组成，这些器件通过内部总线相连

内部总线:实现 CPU 内部各个器件之间的联系

外部总线:实现 CPU 和主板上其他器件之间的联系

8086 CPU 有14个寄存器,他们的名称为:
    AX, BX, CX, DX      //这4个是通用寄存器，用来存放一般性数据
    SI, DI
    SP, BP, IP
    CS, SS, DS, ES      //段寄存器
    PSW

    其中8个是通用寄存器，几乎所有的 CPU 都一样的

DS（data segment）——16位的数据段寄存器；
ES（extra segment）——16位的扩展段寄存器；
SS（stack segment）——16位的堆栈段寄存器；
CS（code segment）——16位的代码段寄存器；

2个地址指针寄存器：BP（base pointer），SP（stack pointer）
2个变址寄存器：SI（source index），DI（desTInaTIon index）

标志寄存器FR（flags register）

16位的指令指针寄存器IP




1. 地址
2. 控制(读/写)
3. 数据

### 通用寄存器

AX, BX, CX, DX      //这4个是通用寄存器，用来存放一般性数据

8086 CPU 的寄存器都是16位的，可以存放两个字节，一个字

8086 的上一代 CPU 8088 是8位的，为保证兼容性，这4个寄存器都可以分为两个**独立的8位寄存器**使用

    AX 可以分为 AH 和 AL
    BX 可以分为 BH 和 BL
    CX 可以分为 CH 和 CL
    DX 可以分为 DH 和 DL

AH 和 AL 都是可以独立使用的8位寄存器

二进制后边加'B'
十六进制后边加'H'
十进制什么也不加


汇编指令不区分大小写

几条汇编指令:

mov ax,18
mov ah,68
add ax,8    //将ax和8相加，放到ax
mov ax,bx




### 物理地址

CPU 访问内存单元时要给出内存单元的地址。

**所有的内存单元构成的存储空间是一个一维的线性空间**

我们将这个唯一的地址称为物理地址


16位结构的 CPU 特征

    1. 运算器一次最多可以处理16位的数据
    1. 寄存器最大宽度是16位
    1. 寄存器和运算器之间的通路是16位的

8086 有20位地址总线，可传送20位地址，寻址能力为1M

8086内部为16位结构，它只能传送16位的地址，表现出的寻址能力却只有64K



    8086
+-----------------------------------------------+
|                                               |
| +---------+                   +-----------+   | 段地址左移16进制一位，即2进制的4位，
| |         |  段地址 16位(CS)  |           |   |
| |   其    |-----------------> |地址加法器 |   |
| |   它    |                   |           |   |
| |   部    |-----------------> |           |   |
| |   件    |  偏移地址16位(IP) +-----------+   |
| |         |                       |物|        |
| |         |                       |理|        |
| |         |                       |地| 20位   |
| |         |                       |址|        |
| |         |                       |  |        |
| |         |                   +-----------+   |               +-----------+
| |         |                   |           |   | 20位地址总线  |           |
| |         |                   |           |-------------------|           |
| |         |                   | 输入输出  |   |               |           |
| |         |                   | 控制电路  |   | 数据总线      |  内  存   |
| |         |                   |           |-------------------|           |
| |         |                   |           |   |               |           |
| |         |                   |           |   | 控制总线      |           |
| |         |                   |           |-------------------|           |
| +---------+                   +-----------+   |               +-----------+
+-----------------------------------------------+



地址加法器合成物理地址的方法：
    
    物理地址 = 段地址 X 16 + 偏移地址

    1230 * F -> 12300

    00C8         00C8
    ------------------
                123C8   20位



段地址x16必然是16的倍数，
偏移地址为16位，16位地址的寻址能力为64KB，所以**一个段的长度最大为16KB**


物理地址        段地址          偏移地址
21F60H          2000H           1F60H
                2100H           0F60H
                21F0H           0060H
                21F6H           0000H
                1F00H           2F60H

CPU 可以用不同的段地址和偏移地址形成同一个物理地址


在 8086 CPU 中， 存储单元的地址用两个元素来描述，即[段地址]和[偏移地址]

21F60H 的表述: 数据存在内存 2000:1F60 单元中


### 段寄存器

8086 CPU 有4个段寄存器:
    CS : code segment   代码段寄存器
    DS : 
    SS :
    ES :

CS 和 IP 是 8086 CPU 中最关键的寄存器，他们指示了 CPU 当前要读取指令的地址

IP 指令指针寄存器




#### 修改 CS IP 的值

1. 使用 r 更改，但这是调试手段

2. mov cs 2000H
    
    但这是不可行的

    mov ax,2000     这个倒是可以的, 但是ip不可以
    mov cs,ax

3. 专门使用 jmp 来修改 CS 和 IP 的值

    **要在汇编代码中执行，不能在debug中直接敲**

    jmp 段地址:偏移地址

        jmp 2AE3:3
        jmp 3:0b16


    仅修改IP的内容，单一修改 IP 的值

        mov ax,200
        jmp ax          类似于 mov ip,ax


### debug 的使用

实模式

R 查看、改变CPU寄存器的内容
    r ax
    rax         // 可以没有空格

D 列出预设地址内存出的128个字节的内容

    64K->64000B/128 => 500
    2^16/2^7 => 2^9 => 512

    1. d 段地址:偏移地址

    2. d 段地址:偏移地址 结尾偏移地址
        
        2000:0 f  -> 启示和结尾，共16个

E 改变内存的值

    e 段地址:便宜地址 数据1 数据2 ...

U 把内存中的机器指令翻译成汇编指令

A 写入汇编指令    


[link](https://www.bilibili.com/video/BV1pi4y1P76P?p=13&spm_id_from=pageDriver)
+-----------------------------------------------+
|                                               |
| +---------+                   +-----------+   | 段地址左移16进制一位，即2进制的4位，
| |         |  段地址 16位(CS)  |           |   |
| |   其    |-----------------> |地址加法器 |   |
| |   它    |                   |           |   |
| |   部    |-----------------> |           |   |
| |   件    |  偏移地址16位(IP) +-----------+   |
| | AX      |                       |物|        |
| | BX      |                       |理|        |
| |         |                       |地| 20位   |
| |         |                       |址|        |
| |         |                      \|/\|/       |
| |         |  +----------+     +-----------+   |               +-----------+
| |         |  |指令缓冲区|-<---|           |   | 20位地址总线  |           |
| |         |  +----------+     |           |-------------------|           |
| |         |       |           | 输入输出  |   |               |           |
| |         |      \|/          | 控制电路  |   | 数据总线      |  内  存   |
| |         |  +----------+     |           |-<<<---------------|           |
| |         |  |执行控制器|     |           |   |               |           |
| |         |  +----------+     |           |   | 控制总线      |           |
| |         |                   |           |-------------------|           |
| +---------+                   +-----------+   |               +-----------+
+-----------------------------------------------+

工作过程的简要描述

1. 从CS:IP 指向的内存单元读取执行，读取的指令进入指令缓冲区

2. IP=IP+所读取指令的长度，从而指向下一条指令

3. 执行指令，转到步骤1，重复这个过程




## 第三章

16位的字在内存中的存储

0 地址单元中存放的字节型数据
0 地址单元中存放的字型数据


DS 和 [address]
    数据的段地址
    [偏移地址]

    mov bx,1000H
    mov ds,bx
    mov al,[0]

    不能直接  mov ds,1000H, 8086的硬件电路没有这样设计

    mov bx,1000H
    mov ds,bx
    mov ax,[0]      // 1000:0处的字型数据
    mov [0],cx      // cx中的16位数据送到 1000:0处


    内存                指令
    10000H  > 23        mov ax,1000
    10001H  > 11        mov ds,ax
    10002H  > 22        mov ax,[0]      // 1122
    10003H  > 66        mov bx,[2]      // 6622
                        mov cx,[1]      // 2211
                        add bx,[1]      // 6622+2211
                        add cx,[2]      // 2211+6622
                        
    e 1000:0

    a 2000:0
    汇编代码

    rcs
    rip

    t


    累加数据段中前3个单元中的数据

    mov ax,123B
    mov ds,ax,
    mov al,0
    add al,[0]
    add al,[1]
    add al,[2]

[link](https://www.bilibili.com/video/BV1pi4y1P76P?p=17&spm_id_from=pageDriver)

mov 寄存器, 数据
mov 寄存器, 寄存器
mov 寄存器, 内存单元
mov 内存单元, 寄存器
mov 段内存单元, 寄存器
mov 寄存器,段内存单元
mov 内存单元,段寄存器

