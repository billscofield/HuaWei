
## Link

https://foxi.buduanwang.vip/vdi/640.html/

## 基于Proxmox VE的VDI云桌面解决方案

桌面虚拟化能够完美解决远程办公带来的各种难题，尤其是在疫情期间，VDI真是火了一把。

相对于Xendesktop和horizon，以及各种厂商的VDI解决方案，PVE从免费，就已经秒杀了全部。从虚拟化底层来说，PVE基于开源的debian，只要会linux，就能快速上手PVE，简单通透的命令指令，可以使PVE运维成本极低。

笔者趁着工作变动，不断摸鱼学着老前辈的经验。看着各种企业级超融合平台，更是对小众的PVE充满希望。

### 一：为什么选择Proxmox VE底层

1. 免费

    VMware vSphere Essentials Kits（6个处理器） 一年最少3W RMB。Citrix 往往捆绑销售。企业超融合平台，还有深信服、华为、nutanix等等。 对于一般企业来说，是个很大的开支。

     而PVE却是免费。算上购买企业仓库，也就1000元/percpu。

 2. 超融合平台

    PVE不仅仅是一个虚拟化底层，他还是个一个超融合平台。什么是超融合？

    超融合基础架构继承了融合式架构的一些特性，同样都是使用通用硬件服务器为基础，将多台服务器组成含有跨节点统一储存池的群集，来获得整个虚拟化环境需要的效能、容量扩展
    性与数据可用性，可透过增加群集中的节点数量，来扩充整个群集的运算效能与储存空间，并透过群集各节点间的彼此数据复制与备份，提供服务高可用性与数据保护能力。而为能灵
    活地调配资源，超融合架构也采用了以虚拟机(VM)为核心，软件定义方式来规画与运用底层硬件资源，然后向终端用户交付需要的资源。


    PVE5.3版本已经集成了ceph分布式储存架构，在管理面板可以直接配置整个集群的ceph，不仅整合集群的储存资源，更完美地实现了HA容灾的存储需求。

    PVE6.2版本集成了SDN网络功能

    proxmox buckup server已经发布测试版本，能够完美的在集群架构下，备份VM或者物理机，给用户带来更强大的容灾能力。

    对于vmware，他将超融合都集成了在了一起，而是不是单独的将计算节点、储存、网络还有管理节点分开。

 3. 开源

    可以在https://git.proxmox.com。查看proxmox的源代码。有能力，可以去做二次开发。

 4. 与Debian同样的兼容性

    PVE基于debian，使用linux的管理命令。专有的PVE管理命令qm也非常简单易懂。在储存上，支持debian支持的一切储存。在网络上，支持debian支持的一切网络。可以把想象PVE是debian上的一个超融合软件。并不需要考虑PVE是否兼容企业的服务器。

 5. 轻量独特的管理架构

    PVE有着独特的“去中心化”。“center”这个词很常见，例如vCenter。我们用一个另一个概念去解释“center”，也就是“管理节点”。管理节点可以是物理机、也可以是虚拟机。

    企业往往会面对管理节点宕机的挑战。

    所幸PVE没有管理节点。
    任何一个节点，都可以控制其他节点，节点与节点之间也没有主从概念。通过反向代理、负载均衡技术或者是HA技术，都可以是PVE的面板永不下线。

     PVE更有一个轻量的管理界面，使用html5、 AJAX 、ExtJS 6.x JavaScript框架。


     在GUI面板上，3侧栏递归式分布，菜单功能一目了然，对于臃肿的vCenter管理界面，简直是眼前一亮。

 6. 完美的laas交付平台

    PVE基于KVM虚拟化，性能无庸置疑，只有1%~3%的性能损失。

    在linux交付上。PVE集成cloud-init组件，可以通过制作模板，可以批量克隆创建linux-VM。
    在Windows交付上。PVE可以完美虚拟2003以上windows guest OS。同时PVE可以通过qemu-guest-agent程序，监控和控制VM。

    利用KVM的CPU模拟技术，集群中不强制要求同样CPU型号的服务器。都可以通过一个名为kvm64的处理器，来进行HA热迁移。

    其底层可以支持ZFS储存，配合ceph，不需要高额的RAID卡等软硬件成本，利用内存、SSD，可以给整个集群带来强大的读写缓存支持。

7. 集成了防火墙的网络虚拟化

    PVE内置防火墙。企业不需要再购买额外的内网网络安防设备。

    通过对VLAN的划分，可以划分不同的资源池。达到不同部门的隔离、互访。

    同样基于debian的os，兼容市面上高性能的100G、400G网卡，利用半虚拟化virtio网卡，轻松可以构建1G、10G、40G、100G内部网络。使用网络限速功能，轻松在逻辑上QOS。PVE也支持SR-IOV，在面板上即可配置vf网卡。

### 二：云桌面架构的选择

    1. 基于RDP的云桌面架构。

    在PVE主机上新建VM，做为guest os。并且加入ad域。
    创建一个RDP桌面网关，作为RDP的连接代理，可以实现内外网分离。

    基于RDP的云桌面架构无疑是最为简单的，百来人一个技术人员都能够游刃有余的解决VM的资源分配以及账户分配。瘦终端也广泛支持。

    但是RDP协议是在OS层面上的，并不能管理VM的电源。也就是如果员工误关机，他就不能自动连接的时候开机。

    这里就有3种解决办法：

    告知给IT人员，让IT人员开机
    将PVE的管理面板给予员工，配置域用户登陆，赋予USER权限。使员工自己能够开关机。
    配置一个专用的VM电源管理模块，可以是一个web、可以是一个程序，也可以是一个脚本。
    显而易见第二种方法无疑是最便捷的。第二种方法很好，但需要技术支持。第三种方法比较浪费人力。

2. 基于spice协议的云桌面

    PVE基于KVM，当然支持SPICE。PVE面板上，给VM配置了QXL显示适配器，即可使用SPICE显示器。需要客户端安装virt-viewer。

    PVE面板上的SPICE默认是由PVE的3128端口代理的。所以，如果要使用spice协议进行云桌面。有3种解决方案

    进入webgui，下载spice连接配置文件
    创建启动脚本/程序，自动下载spcie连接配置文件
    修改VM配置文件，固定spice连接端口
    显而易见第一种方法无疑是最便捷的。第二种方法很好，但实现自动化，需要技术支持。第三种方法比较浪费人力，需要IT人员手动下发配置或者更改密码。

3. 基于horizon的云桌面

    虽然底层是PVE，但并不影响horizon的部署。缺点是需要horizon授权和没有3D支持。同样是没有电源管理功能。

4. 基于xendesktop的云桌面

    如果在PVE上添加GPU加速器，给VM添加虚拟显卡，使用xendesktop，可以发挥VM的3D性能。能够进行3D渲染，甚至游戏。 缺点是需要授权。同样是没有电源管理功能。

### 三：企业如何选择

    在千人以下，选择RDP也是非常可观的，近乎0额外成本。（除开window的授权和IT人员的开销）

    有钱的去购买vmware组合包

### 相关文章

在Proxmox VE pve中安装windows操作系统——以ltsc2019为例
pve虚拟机VGPU方案简析
PVE中 qemu guest agent的安装和使用
ProxmoxVE pve安装win7系统（多图）
Proxmox VE（pve&kvm）中的efi系统
