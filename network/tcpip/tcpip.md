# TCP/IP

B/S架构, 实际是C/S架构的泛化、特例, 将客户端泛化，中心还是 Server

应用程序通常是进程，下三层是在内核实现

UDP:
    TFTP
    DNS

TCP:
    FTP

## 层次划分

### OSI/RM

1. Application

2. Presentation

3. Session

4. Transport

5. Network

6. Data Link
    The term "frame" in the context of networking and data communication has
    been used for many decades, and it's not clear who first coined the term.
    However, it's likely that the term comes from the idea of a picture frame
    or a window frame, which provides a border or a boundary around a
    particular piece of content. Similarly, a data link layer frame provides a
    boundary around the data being transmitted, including a header and a
    trailer that contain information about the data and the communication
    itself. The frame allows the data link layer to identify and differentiate
    different packets of data on the same network.

7. Physical

### TCP/IP

1. Application

2. Transport

3. Internet

4. Network Access

对等层 Peer Layer

对等层通信(Peer-to-Peer Comm)

每一层可以同时存在多个实体

    应用层实体有outlook,IE,FTPServer,MailServer,wwwServer...

    存在通信关系的对等层实体才是对等实体

        如 Outlook 和 Mail Server 才是对等层实体

每一层可以同时存在多个协议

    smtp, http, ftp

实体表示任何可发送或接收信息的硬件或软件进程

协议是控制两个对等实体进行通信的规则的集合

### 会话层

拿QQ来举例，QQ软件有一个端口号，但是不同人之间的会话是隔离的

一个端口有很多会话; 一个大对数有很多芯

### IP 是不可靠的

唯一标识互联网上的主机或路由器

tcp 相当于卖家，ip 相当于物流，顾客收到货物后才会付款，但是 IP(物流) 不一定能送
到

### "连接"和"可靠没有必然的关系"

如果没有提供差错控制、流量控制等可靠性机制，即使连接的通信也是不可靠的

只是面向连接的可靠性更容易实现

## ping -s 最大值

1500 MTU   数据链路层的一个帧, 所以包含各种头部+数据

一个数据链路层帧最大值是 1500Bytes

ip header 是 20Bytes

icmp header 是 8Bytes

1500 - 20 - 8 = 1472 Bytes

所以 ping -s 最大值是 1472 

### classD

https://www.paessler.com/it-explained/ip-address

224-239

Class D addresses are 32-bit network addresses, meaning that all the values within the range of 224.0.0.0 – 239.255.255.255 
are used to uniquely identify multicast groups. There are no host addresses within the Class D address space, since all the 
hosts within a group share the group’s IP address for receiver purposes.

### classE

240-255

While this class is reserved, its usage was never defined. As a result, most network implementations discard these addresses 
as illegal or undefined. The exception is 255.255.255.255, which is used as a broadcast address.

最基本的协议号、端口号

1. 以太网协议号(在数据链路层中表明)
    IPv4    : 0x0800
    IPv6    : 
    ARP     : 0x0806
    PPPOE   : 0x8863 0x8864

1. IP协议号(在网络层中表示)
    ICMP: 1
    IGMP: 2
    IP  : 4(隧道)
    TCP : 6
    EGP : 8
    UDP : 17
    IPv6: 41(隧道)
    GRE : 47
    ESP : 50
    AH  : 51

1. 端口号(在传输层表示)
    FTP     : 20(Data) 21(control)
    SSH     : 22
    SFTP    : 22
    Telnet  : 23
    SMTP    : 25
    POP3    : 110
     IMAP   : 143
    TACACS+ : 49
    HTTP    : 80
    HTTPS   : 443
    IKE     : 500
    Radius  : 1645 1646 1812 1813

    well-known ports: from 0 through 1023

    |                   +---+    +---+
    |                   |TCP|    |UDP|
    |                   +---+    +---+
    |   +----+  +----+    |        |
    |   |ICMP|  |IGMP|    |        |
    |   +----+  +----+    |        |
    |    |        |       |        |
    |     \       |       |       /
    |      \      |       |      /
    |       \     |       |     /
    |        \    |       |    /
    |         \   |       |   /
    |          \  |       |  /
    |        +----------------+   +---+   +----+
    |        |      IP        |   |ARP|   |RARP|
    |        +----------------+   +---+   +----+
    |                       |       |       / 
    |                        \      |      /
    |                         \     |     /
    |                          \    |    /
    |                           \   |   /
    |                          +---------+ 
    |                          | 以太网  |
    |                          +---------+ 

### 路由跟踪 

linux
    ping -R <目标>

Cisco 路由器
    ping 
    根据提示进行设置

## telnet route-server.ip.att.net

用户名: rviews
密  码: rviews

查看全球 IP 路由信息

## RFC 需求等级

RFC 2119

1. 必需的 must
1. 推荐的 recommended
1. 选用的
1. 限制使用的
1. 不推荐的

## 虚电路交换

1. 再发送第一个数据包之前要进行连接的建立，一般等待时间位 RTT

1. 连接请求包含完整的目的地址，但每个数据包只携带很小的 VC 标识，一次每个包的开销较小

1. 如果链接上的链路或交换机故障，必须建立一个新的连接。

1. 连接建立位预留资源提供了支持

VC标识: Virtual Circuit

### 虚电路的实现

VC转变表的维护

    1. 每当建立了一条新 VC 时，在表中添加一项
    1. 每当终止一条 VC 时, 在表中删除相应条目

    +-------------------+-------------------+
    |        入境       |        处境       |
    +-------------------+-------------------+
    |  境线路|虚电路号  |  出境线路|虚电路号|
    +-------------------+-------------------+
    |     A  |  0       |     B    |   0    |
    +-------------------+-------------------+
    |     A  |  1       |     C    |   0    |
    +-------------------+-------------------+



## ATM 虚电路网络

从电话网络进化而来
人类的习惯
    严格的时序，可靠性需求
    需要有保证的服务
哑端系统
    电话
    复杂性在网络内部




802.3   以太网
802.4   令牌总线
802.5   令牌环
X.25    是一个使用电话或者ISDN设备作为网络硬件设备来架构广域网的ITU-T网络协议


LAN技术    接入方法    地址    速率                帧
Ethernet   CSMA/CD     6       10M,100M,1G,10G	   数据帧
TokenRing  令牌传递    6       4M, 16M             数据帧，令牌帧，异常终止帧
FDDI       令牌传递    2或6    100M                数据帧，令牌帧(光纤分布式数据接口)


**广域网中的链路层没有 LLC,MAC 的划分**


传输网关在传输层连接字节流
应用网关允许第4层以上的互联


ethernet 帧和802.3帧的判别

Preamble 前导符
SFD      帧定位符



Ethernet

|Byte 7      1    6                   6             2     46-1500   4
|+----------+------------------------+-------------+-----+---------+-----+
|| Preamble | SFD | Destination Addr | Source Addr | Type| Data    | FCS |
|+----------+------------------------+-------------+-----+---------+-----+
|                                                       /          \
|                                                      /            \
|                                                     /              \
|                                                     +--------------+
|                                                     | IP/ARP Packet|
|                                                     +--------------+
|                                                      46-1500   
|

802.2/802.3

|Byte 7      1    6                   6             2     46-1500   4
|+----------+------------------------+-------------+-----+---------+-----+
|| Preamble | SFD | Destination Addr | Source Addr | Len | Data    | FCS |
+----------+------------------------+-------------+-----+---------+-----+
|                                                       /          \
|                                                      /            \
|                                                     /              \
|                               +----------+-----------+--------------+
|                               | 802.2LLC | 802.2SNAP | IP/ARP Packet|
|                               +----------+-----------+--------------+
|                                   3           5           38-1492




## 地址

### 链路层地址

1. 标识通信节点
1. 节点所属 LAN 或 WAN 指定
1. WAN 中并不是都是物理地址，有些时软件定义，如 ATM 虚电路
拨号上网时是电话号?
1. LAN 或 WAN 内唯一

### IP地址


### 端口地址

1. 标识通信进程
1. 操作系统指定
1. 一台计算机内唯一
1. 传输层

### 目的地址

1. 单播(unicast)

1. 多播(multicast)
    链路层多播一定是符合：0x0100.5E
    网络层是:  224.
    本地级或全局级

1. 广播(broadcast)
    本地级


## TCP/IP版本

1. Version 4
1. Version 5
1. Version 6



中继器
    1. 放大器
    1. 信号再生器
        会剔除噪声

    缺点:
        引入延迟
        不具备检错/纠错能力
        不能适用于不通速度的以太网

网桥
    有两个口，网段指的就是一边，而不是三层的网段概念


路由器
    一种用于连接两个运行相同/不通协议的IS(中间系统)

网关
=======
路由器(覆盖下三层)
    一种用于连接两个运行相同/不通协议的IS(中间系统)

网关(覆盖整个7层)

    用于连接两个异构的相互独立的网络, 可以支持不通协议之间的转换。

    协议网关
        用于使用不通协议的网络之间进行协议转换

        链路层网关
            解决两种不通帧格式的网络之间的互联
        网络层网关
            完成不通网络层协议之间的转换，如 IPV4 和 IPV6 的转换
        
    应用网关
        用于不通格式之间翻译数据的系统, 如 EMAIL 网关
        POP
        X.400
        SMTP
        MHS

    安全网关(防火墙)

防火墙



路由选择

    非自适应算法(静态路由)

    自适应算法(动态路由)
        
        缺点
            
            路由决策复杂
            
            依赖于状态信息
            
            不能太快和太慢
            
        优点
            
            可提高网络性能
            
            有助于拥塞控制

路由算法的特性

    正确性

    简单性(减少开销)

    健壮性(网络中局部出现问题时，能避免跳坑)

    稳定性(不能来回翻摆)

    最优性(优先级的优化)

    公平性

    有效性(投入产出,路由等的维护与开销)

### 路由技术元素

性能标准

    1. 跳计数

    1. 成本
        
        与链路有关
        
        与数据率有关(数据率越高，成本越低)
        
        与当前排队延迟有关

    1. 延迟

    1. 吞吐量

网络信息源

    大多数路由决策要求根据网络拓扑，交通负载，链路成本等做出决定

    1. 无

    1. 局部

    1. 邻接节点

    1. 全部节点

信息更新时间

    1. 连续

    1. 定期

    1. 负载变化

    1. 拓扑变化

决策时间(路由表什么时候生成)

    1. 包(数据报)
        
        数据报到达时
        
        为每个包单独作路由决策
        
    1. 会晤(虚电路)
        
        虚电路建立时

决策地点
    1. 每个节点(分布)
        
        每个节点都负责位到达的包选择一条输出链路
        
    1. 中心节点(集中)
        
        由某些指定节点(如网络控制中心)负责决策
        
    1. 原始节点(源端)
        
        由源站点而非网络做出

自适应策略

    1. 故障

    1. 拥塞



### 静态路由算法

中心路由目录

    1 2 3 4 5 6
  1 -
  2   -
  3     -
  4       -
  5         -
  6           -


### 最短路径选择

最小跳数
最短距离
信道带宽
传输延迟
平均通信量

### 距离向量算法

#### DV算法的特点

1. 分布式的

    每个节点接收来自与其直接邻接节点的信息执行路由计算，将计算结果回传给直接邻接的节点

1. 迭代的

    计算过程循环进行，知道相邻节点没有可交换的信息位置

1. 异步的

    并不要求所有节点相互锁步操作




## 传输媒介

### 双绞线:    Twisted-pair cable

### 同轴电缆： Coaxial cable

### 光纤:      Fiber-optic cable

单模和多模光纤的区别是什么
    https://www.zhihu.com/question/40683684


### 非导向型介质

[3KHz,300GHz]



10Base-T 
    基带传输


## 交换

电路交换 circuit switching

报文交换 message switching
    要发送的整块数据成为一个“报文”。通过路由转发
    整个报文先传送到相邻节点，全部存储下来后查找转发表，转发到下一个节点

分组交换 packet switching
    数据报, Datagram
    虚电路, Virtual Circuit, VC


## 广域网

交换网络: 点对点式

    电路交换，分组交换

技术
    1. 


LAN vs. WAN

地理范围     LAN    WAN
延迟
速率
信道         广播   点对点
协议



## 特殊IP地址

分类标识 + 网络号 + 主机号

本网络上的特定主机: netid全部为零，主机位不为零
    基本上没有实现这个地址的通信方式

本网络上的本主机: 0.0.0.0


## 广播

直接广播: 标识特定网络中的所有主机

受限广播: 255.255.255.255

???这连个广播都是直接返回了，在另一个网段并没有抓到任何包

广播只可能是本地级别


路由器的一个接口可以有多个 IP


## 子网掩码速记

0    128    192   224    240    248    252    254   255
/0   /1     /2    /3     /4     /5     /6     /7    /8

超网只是针对C类网

合并超网的C类王个数Nc=2^n (n表示借了几位)

合并超网的C类王必须是连续的


192.168.0.0/24
192.168.1.0/24
192.168.2.0/24
192.168.3.0/24

192.168.0.0/22
借了2bit表示超网，2bit是2^2=4个C类网, 即超网范围是 192.168.0.X-192.168.3.X


使用超网技术减少路由表项的数目





## 交付和路由选择

Delivery 交付
    对分组的物理转发


Routing 路由选择，选路
    对分组寻找路由


route 路由，路径
routing 路由，路由选择，选路


## 面向连接和无连接服务/协议
	
            面向连接                                 无连接

通信过程    建立连接->交付分组->终止连接             交付分组

路由选择    仅在建立连接时选路                       每个分组独立选路

传输路径    相同                                     可以不同




## 直接交付和间接交付

直接交付
    分组目的与分组的**发送接口**在同一 IP 网络中
    同一个局域网中的计算机间是直接交付

间接交付
    分组目的与分组的**发送接口**在不同一 IP 网络中
    交付的第二阶段,路由器发送到目的主机是直接交付   





## 特定路由

主机路由
掩码值全为 1

作用: 
    1. 交付路径


默认路由
    目的网络地址: 0.0.0.0
    目的网络掩码: 0.0.0.0

作用:
    1. 减小路由表


## 静态和动态路由选择

静态路由选择				动态路由

1. 管理员手工设置			路由协议自动发现	
1. 管理员手工更新			路由协议自动更新
1. 不能保证路由的一致性和及时性		保证路由的一致性和及时性
1. 管理性强				管理性弱
1. 没有路由开销				产生一定的路由开销
1. 小型、变化缓慢网络			大型、迅速变化网络



## 路由表的构成过程

初始化阶段-路由发现

    推导初始路由
        直连网络 -> 直连路由

    无法推导部分
        手工设置 -> 静态路由
	路由器间交换选路信息 -> 动态路由


维护阶段-路由更新(网络拓扑更改时)
    手工、静态更新
    路由协议自动、动态更新


## 路由选择

从上到下依次执行，同 iptables

路由表表项的排列顺序
    直连路由
    主机路由
    网络路由
    默认路由

**从上到下，掩码值越来越少，即最长掩码匹配，优先查找较小的网络**



### IP

优先级: 对分组进行处理(排队或丢弃)的优先权，[0,7(网络控制，根据网络进行安排)], 未用

TOS: 该分组所**期望**的服务器质量

一般是通过应用层上进行控制的


RFC 2474
    DSCP(differentiated services code point)

为什么要有分组呢?
任何一个物理网络都有一个传输能力限制, 以太网一个帧最大时1518Bytes, 所以IP分组就要分割成可以
在以太网链路上进行传输的大小，这叫做分片


数据帧中的数据大小
+-------------------+-------+
|物理网             | MTU   |
+-------------------+-------+
|Token Ring(16Mbps) | 17914 | 
|Token Ring(4Mbps)  | 4464  |
|FDDI               | 4352  | 
|Ethernet           | 1500  | 
|X.25               | 576   | 
|PPP                | 296   | 
+-------------------+-------+

分片仅由路由器执行

确实需要时才进行分片: 提高传输效率
每个分片都要包含IP首部: 无连接通信
数据包可被多次分片


### 片偏移的例子

一个数据报total length:4020, 假设MTU是1420

需要分3个片
    1. [0,1399]   片偏移 0
        [0,1399]
    2. [0,1399]   片偏移 1400/8=175
        [1400,2799]
    3. [0,1399]   片偏移 2800/8=350
        [2800,3999]

片偏移的计算只考虑数据部分，不用考虑首部


TTL 为了防止路由环路，但是实验观察并没有出现TTL持续减1的流量，还是首先默认的icmp包
TTL 减1 比较是否为0


只校验首部，数据部分由高层协议校验
    无需重复校验数据部分
    缩短了路由器转发分组时的处理时间






Ethernet
FastEthernet
Giga




## Internet Layer

记录路径: : 让每个路由器都记下它的IP地址

    R选项, 记录出接口IP, ping -R

    40个字节中,最多记录 9Bytes, 而且是双向的, 而且要求经过的设备都要支持 R 选项
    中间最多一个设备

    +-----------------------------------------------------+
    |               IP HEADER                             |
    | code(1)   len(1)    ptr(1)     IP1      IP2    ...  |
    +-----------------------------------------------------+
    |               IP DATA                               |
    +-----------------------------------------------------+

时间戳: 让每个路由器都记下它的IP地址和时间

    代码为 0x44
    len 和 ptr 与 记录路由选项相同
    len 一般为 36 或 40
    ptr 指向下一个可用空间(5,9,13等)

宽松源站路由: 为数据包指定一系列必须经过的IP地址
    R1,R2,R3 等可以不是直连

严格源站路由: 与宽松源站路由类似，但是要求只能经过指定的这些地址,不能经过其他地址
    R1,R2,R3 等必须是直连



0.0.0.0     DHCP会使用

环回口      127.X

受限广播    255.255.255.255     

    limited broadcast 

    用于DHCP时的目的地址, 路由器不会转发

    又称本地广播地址，

    通常计算机启动时，希望从网络IP地址服务器DHCP处获得一个IP地址。

　　二层的目的地址为FF:FF:FF:FF:FF:FF，三层的目的地址为255.255.255.255，源地址为0.0.0.0。

直接广播    包含有效的网络号

    directed broadcast

    当主机需要寻找网络中的邻居时，发出直接广播包

    有限广播的数据包里不包含自己的ip地址，而直接广播地址里包含自身的ip地址。

分片:
    IP首部被复制到各个片中。但是，端口号在UDP首部，只能在第一片中被发现
    即只有第一个片中才有4层信息
    如果第一片就丢失了，没有收到，就不会发ICMP报文了

    vpn 中出现分片，就不能正常工作了


源站抑制:
    ICMP源站抑制报文




### traceroute

linux

用的UDP

源端口号:  一次 Traceroute 过程也可能发生变化

目的端口号: 大于30000, 可能TTL=1,2,3,...的时候是递增的

TTL=1, 收到 ICMP 信息, 记录IP地址, 发送3次
TTL=2, 收到 ICMP 信息
...
TTL=n, 目的主机发送端口不可大差错, 说明到达目的地了, 发送ICMP信息



### tracert

windows

就是发 ICMP echo request


### 源站路由

目的地址是D, 选项中还有3个地址R1,R2,R3

实现逐跳改变IP地址

    dest=D
    (R1,R2,R3)
    +---+               +----+              +----+           +----+          +---+
    | s |-- dest=R1---> | R1 |--- dest=R2 ->| R2 |--dest=R3->| R3 |--dest=D->| D |
    +---+               +----+              +----+           +----+          +---+


禁用: 思科    no ip source-route

traceroute 可以使用 源站路由记录实现 ping -R 的效果, 原理:

    traceroute 记录的是入接口的ip

    traceroute 目的 和 源都是本机, R1 为远端服务器   

    这样设置即可


## ARP

arp 广播，目标地址的mac 是00:00:00:00:00:00, 表示不知道

1: arp请求
2: arp应答
3: rarp请求
4: rarp应答


### 免费 arp

自己配了一个IP, 比如1.1.1.1, 本机发送一个 arp 广播, 我的 IP 是 1.1.1.1, 我的物
理地址是 XXXXXX, 请问1.1.1.1 的物理地址是多少?

ARP表按理说应该会进行更新操作的吧? 用hub?

看看这个IP 是不是 Free 的(空闲的,翻译成免费太狗血了)




### 代理 arp

no ip routing 的设备, 需要开启 代理arp 功能


|+-----+                 +-----------+               +----------+
|| PC1 |---------------> |  Router 1 |-------------->| Server 1 |
|+-----+                 +-----------+               +----------+
|                     这个口代理 arp

如果是有路由:
    
    1. 直连网络
        直接发了
        
    2. 非直连网络
        发送给网关


## ICMP

当发送一份ICMP差错报文时，报文始终包含IP的首部和产生ICMP擦错报文的IP数据报数据
区域的前8个字节(即TCP/UDP报文的前8个字节). 这样, 接收ICMP差错报文的模块就会把它
和具体的某个协议和用户进程联系起来

不产生ICMP报文的情况:
    
    1. ICMP 差错报文自身

    2. 目的地址是广播地址或多播地址

    3. 不是IP分片的第一片, (只有第一片才有端口号等信息)

    4. 源地址不是单个主机的数据报, 即源地址不能是零地址,环回地址, 广播地址或多播地址


ping -s size

    size: IP + ICMP + Data; 是整个ICMP包的大小
    -s 500
        IP: 20
        ICMP: 8 
        Data: 478



需要分片但是有设置不分片标志比特时，ICMP不可达差错报文

    3 | 4:Fragmentation required, and DF flag set
    
    DF 位也是双向的

    如果mtu过大,有的路由器是不回复mtu的

    vpn 隧道口要加 vpn 头部, 一般要设置 mtu




半双工只用了一对网线?




## 重定向

|           +-----------+
|           |   host    |
|           +-----------+
|      1     |  /|\                             1. IP数据报
|    +-------+   | 2                            2. ICMP重定向
|    |   +-------+                              3. IP数据报
|    |   |  +---------------+ 3
|   \|/  |  |              \|/
|  +---------+            +--------+
|  |   R1    |            |   R2   |
|  +---------+            +--------+
|                           |
|                          \|/
|                       最终目标
|


当路由器转发一个数据报时发现接收的接口和发送的接口在同一接口，这时候路由器会跟
源端自己发送一个ICMP重定向信息，告诉源端下次把数据报发送给另一个路由器，那样才
是最优的。

只有no iprouting设备下次才会将数据报之间发送给另一个路由器。Ip routing 设备会继
续将包发送给它，不理睬ICMP重定向差错信息。


不具备ip routing的设备，哪怕自己有路由条目也不会帮其他人转发路由（交换机），而
路由器有ip routing，会转发不具备ip routing的设备（no ip routing）


## UDP

三大典型运用

1. 查询类:DNS

2. 数据传输:TFTP

    停止等待协议, 慢(需运用层确认数据)

    适合于无盘工作站

3. 语音视频流

    支持广播和组播

    支持丢包，保障效率


TCP端口和UDP端口是相互独立的, 比如相同的端口号各有一个协议, 53,TCP,UDP 都在用
rsh(TCP) 和 syslog(UDP) 端口号都是514



## 广播与多播

广播和多播仅用于UDP

普通模式: 仅接收本机MAC地址的单播地址,和广播/组播地址


UDP广播包在UDP层才会发起丢弃

    如果UDP端口没有应用程序侦听,则丢弃


受限广播        255.255.255.255
指向网络的广播
指向子网的广播
路由器支持255.255.255.255， windows 不支持



## TCP

SYN 和  FIN 要占用一个序号
ACK 无需占用任何序号
只有第一个没有ACK, 其余的都有ACK


选择性确认或否认
    收到一个包, 不能进行选择行确认活否认, 如果不对, 我就还发送希望得到的包
    
    但是新的RFC已经支持


window size:
    在接收方未确认的情况下, 可以连续发 window size 数据

TCP的checksum 是强制的, 而 UDP 是非必须的
    
**URG 是一个偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号**

TCP 可以没有 payload

### 可选字段:

MSS: Maximum segment size

    每个连接方通常都在通信的第一个报文段(为建立连接而设置SYN标志的那个段)中
    指明这个选项。它指明本端所能接收的最大长度的报文段
    
    如果一方不接收来自另一方的MSS值, 则MSS就定为默认值536
    如果是直连网络, MSS-40(TCP 和 IP Header)
    
    PMTU: Pass MTU


当一端为建立连接而发送他的SYN时，它为连接选择一个初始序号. ISN 随时间变化, RFC
793指出 ISN 可看作是一个32bit的计数器，每4ms加1

发送 FIN 的一方, 即之后不再回复对方的ACK请求


大多数伯克利系统将建立一个新连接的最长时间限制为75秒.

TIME_WAIT 
    
    MSL报文段最大生存时间(Maximum Segment Lifetime)

    RFC 793 指出 MSL 为2分钟, 而实现中常用值是 30秒, 1分钟, 2分钟

    2MSL

    在这个2MSL时间中, 是不可用的, 是不接收请求的


每个选项的开始是 1Byte kind 字段，说明选项的类型, 在 kind 字节后还有 len 字段,
它说明的长度是该选项的长度

    例如:
        
        +--------+------------------------+
        | kind=2 | len=4 | 最大报文段长度 |
        +--------+------------------------+
        1Byte     1Byte   2Bytes

选项表结束   kind=0

时间戳
    
    +--------+--------+----------+----------------+
    | kind=8 | len=10 | 时间戳值 | 时间戳回显应答 |
    +--------+--------+----------+----------------+
    1Byte    1Byte    4Byte      4Byte              要添加2Byte以便符合4Byte边界
4字节边界


### RST

1. 到一个不存在的端口时, 会回复一个RST报文

1. 异常终止一个连接

1. 检测半打开连接


Nagle 算法
    
    减少小包的发送, 增加时延
    如果需要实时性较高, 需要关闭

        某些案件会产生多个字符, 例如F1, 产生3个字节: esc键, 左括号和一个M.发送
        了esc键,发送端需要服务器端发送ack才会发送剩下的bytes, 但是服务器受到的
        是不完整的, 不会发送 ack, delay time后超时重传


隔一个报文段确认

    接收方接收到2个报文段才发送一个ACK

    delayed ack

### 快的发送方，慢的接收方

ack xxx, win 0      : 不要发了
ack xxx, win 4096   : 窗口更新

窗口合拢, 发生在数据被发送和确认时, 
    
    窗口左边沿向右边沿靠近: 

窗口张开
    
    当窗口右边沿向右移动时将允许发送更多的数据，这种现象发生在另一端的接收
    进程读取已经确认的数据并释放了 TCP 的接收缓存时

窗口收缩 
    
    当右边沿向左移动时

还要考虑 MSS 大小

PUSH

    通知接收方将所受到的数据全部提交给接受程序

慢启动(slow start)

    如果存在低速链路或速度不满足

    降低一开始就发送过多的数据到网络

    增加一个窗口, 拥塞窗口(Congestion window), 记作 cwnd, 记作 cwnd

    当与另一个网络的主机建立TCP连接时，拥塞窗口被初始化为1个报文段, 每收到一个
    ACK, 拥塞窗口就增加一个报文段(cwnd 以字节为单位，但是满期动以报文段大小为单
    位进行增加). 发送方取拥塞窗口与通告窗口中的最小值作为发送上限.

    1 --> 2 --> 4, 指数增加的关系

    拥塞窗口是发送方使用的流量控制
    而通告窗口是接收方使用的流量控制

    在某些点上可能达到了互联网


时延带宽积
    
    为了最大限度的利用链路带宽，必须确保发送发源源不断的收到接收方发送的ACK, 作
    为对收到数据的确认和更新 window size 的大小

    在开始阶段，通告的 window size 必须大于等于带宽和往返时延的乘积,才能确保在
    受到第一个ACK前,能够一直发送数据流量, 因为发送第一个数据报文到受到对应的ACK,
    时间至少是RTT时间

    因此传送通道容量为:
        
        capacity(bit) = bandwidth(b/s) x roud-trip time(s)
### 超时重传

1. 重传定时器
    用于当发送一个数据报文时，在规定时间内，发送方需要收到另一端发出的接受报文确认

1. 坚持定时器(persist)
    使窗口大小信息保持不断流动,即使另一端关闭了其接收窗口

1. 保活定时器(keepalive)
    用于检测一个空闲连接的另一端是否依然还保持连接

1. 2MSL定时器
    测量一个连接处于TIME_WAIT状态的时间

RTT时间测量

    1. 方法一, RFC 793

    2. 方法二, Jacobson
        
        A:平滑的RTT
        D: 平滑的均值偏差
        Err: 刚刚得到的测量结果与当前的RTT估计器之差
        RTO=A+4D

拥塞避免算法

    超时和收到重复的ACK

    https://www.bilibili.com/video/BV1Mx411v7rJ?p=13&spm_id_from=pageDriver

    是一种处理丢失分组的方法

    是发送方对网络可能发生拥塞的估计

    cwnd 指数增加, cwnd加1的方式增加
