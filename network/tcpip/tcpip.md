## 

B/S架构, 实际是C/S架构的泛化、特例, 将客户端泛化，中心还是 Server

应用程序通常是进程，下三层是在内核实现


UDP:
    TFTP
    DNS

TCP:
    FTP


## 层次划分

### OSI/RM

7. Application		
6. Presentation
5. Session
4. Transport
3. Network
2. Data Link
1. Physical

### TCP/IP

4. Application
3. Transport
2. Internet
1. Network Access


对等层 Peer Layer
对等层通信(Peer-to-Peer Comm)

每一层可以同时存在多个实体
    应用层实体有outlook,IE,FTPServer,MailServer,wwwServer...

    存在通信关系的对等层实体才是对等实体
    	如 Outlook 和 Mail Server 才是对等层实体

每一层可以同时存在多个协议
    smtp
    http
    ftp

实体表示任何可发送或接收信息的硬件或软件进程

协议是控制两个对等实体进行通信的规则的集合




### 会话层

拿QQ来举例，QQ软件有一个端口号，但是不同人之间的会话是隔离的

一个端口有很多会话; 一个大对数有很多芯



### IP 是不可靠的

唯一标识互联网上的主机或路由器

tcp 相当于卖家，ip 相当于物流，顾客收到货物后才会付款，但是 IP(物流) 不一定能送到




### 连接 和 可靠没有必然的关系

如果没有提供差错控制、流量控制等可靠性机制，即使连接的通信也是不可靠的

只是面向连接的可靠性更容易实现


## ping -s 最大值

1500 MTU   数据链路层的一个帧, 所以包含各种头部+数据

一个数据链路层帧最大值是 1500Bytes

ip header 是 20Bytes

icmp header 是 8Bytes

1500 - 20 - 8 = 1472 Bytes

所以 ping -s 最大值是 1472 


### classD

https://www.paessler.com/it-explained/ip-address

224-239

Class D addresses are 32-bit network addresses, meaning that all the values within the range of 224.0.0.0 – 239.255.255.255 
are used to uniquely identify multicast groups. There are no host addresses within the Class D address space, since all the 
hosts within a group share the group’s IP address for receiver purposes.

### classE

240-255

While this class is reserved, its usage was never defined. As a result, most network implementations discard these addresses 
as illegal or undefined. The exception is 255.255.255.255, which is used as a broadcast address.





最基本的协议号、端口号

1. 以太网协议号(在数据链路层中表明)
    IPv4    : 0x0800
    IPv6    : 
    ARP     : 0x0806
    PPPOE   : 0x8863 0x8864

1. IP协议号(在网络层中表示)
    ICMP: 1
    IGMP: 2
    IP  : 4(隧道)
    TCP : 6
    EGP : 8
    UDP : 17
    IPv6: 41(隧道)
    GRE : 47
    ESP : 50
    AH  : 51

1. 端口号(在传输层表示)
    FTP     : 20(Data) 21(control)
    SSH     : 22
    SFTP    : 22
    Telnet  : 23
    SMTP    : 25
    POP3    : 110
     IMAP   : 143
    TACACS+ : 49
    HTTP    : 80
    HTTPS   : 443
    IKE     : 500
    Radius  : 1645 1646 1812 1813

    well-known ports: from 0 through 1023



                    +---+    +---+
                    |TCP|    |UDP|
                    +---+    +---+
    +----+  +----+    |        |
    |ICMP|  |IGMP|    |        |
    +----+  +----+    |        |
     |        |       |        |
      \       |       |       /
       \      |       |      /
        \     |       |     /
         \    |       |    /
          \   |       |   /
           \  |       |  /
         +----------------+   +---+   +----+
         |      IP        |   |ARP|   |RARP|
         +----------------+   +---+   +----+
                        |       |       / 
                         \      |      /
                          \     |     /
                           \    |    /
                            \   |   /
                           +---------+ 
                           | 以太网  |
                           +---------+ 


### 路由跟踪 

linux
    ping -R <目标>

Cisco 路由器
    ping 
    根据提示进行设置



## telnet route-server.ip.att.net

用户名: rviews
密  码: rviews

查看全球 IP 路由信息


## RFC 需求等级

RFC 2119

1. 必需的 must
1. 推荐的 recommended
1. 选用的
1. 限制使用的
1. 不推荐的







## 虚电路交换

1. 再发送第一个数据包之前要进行连接的建立，一般等待时间位 RTT

1. 连接请求包含完整的目的地址，但每个数据包只携带很小的 VC 标识，一次每个包的开销较小

1. 如果链接上的链路或交换机故障，必须建立一个新的连接。

1. 连接建立位预留资源提供了支持

VC标识: Virtual Circuit




### 虚电路的实现

VC转变表的维护

    1. 每当建立了一条新 VC 时，在表中添加一项
    1. 每当终止一条 VC 时, 在表中删除相应条目

    +-------------------+-------------------+
    |        入境       |        处境       |
    +-------------------+-------------------+
    |  境线路|虚电路号  |  出境线路|虚电路号|
    +-------------------+-------------------+
    |     A  |  0       |     B    |   0    |
    +-------------------+-------------------+
    |     A  |  1       |     C    |   0    |
    +-------------------+-------------------+



## ATM 虚电路网络

从电话网络进化而来
人类的习惯
    严格的时序，可靠性需求
    需要有保证的服务
哑端系统
    电话
    复杂性在网络内部




802.3   以太网
802.4   令牌总线
802.5   令牌环
X.25    是一个使用电话或者ISDN设备作为网络硬件设备来架构广域网的ITU-T网络协议


LAN技术    接入方法    地址    速率                帧
Ethernet   CSMA/CD     6       10M,100M,1G,10G	   数据帧
TokenRing  令牌传递    6       4M, 16M             数据帧，令牌帧，异常终止帧
FDDI       令牌传递    2或6    100M                数据帧，令牌帧(光纤分布式数据接口)


**广域网中的链路层没有 LLC,MAC 的划分**


传输网关在传输层连接字节流
应用网关允许第4层以上的互联


ethernet 帧和802.3帧的判别

Preamble 前导符
SFD      帧定位符



Ethernet

Byte 7      1    6                   6             2     46-1500   4
+----------+------------------------+-------------+-----+---------+-----+
| Preamble | SFD | Destination Addr | Source Addr | Type| Data    | FCS |
+----------+------------------------+-------------+-----+---------+-----+
                                                       /          \
						      /            \
						     /              \
	                                             +--------------+
			                             | IP/ARP Packet|
	                                             +--------------+
				                      46-1500   


802.2/802.3

Byte 7      1    6                   6             2     46-1500   4
+----------+------------------------+-------------+-----+---------+-----+
| Preamble | SFD | Destination Addr | Source Addr | Len | Data    | FCS |
+----------+------------------------+-------------+-----+---------+-----+
                                                       /          \
						      /            \
						     /              \
	                          +----------+-----------+--------------+
			          | 802.2LLC | 802.2SNAP | IP/ARP Packet|
	                          +----------+-----------+--------------+
				  3           5           38-1492




## 地址

### 链路层地址

1. 标识通信节点
1. 节点所属 LAN 或 WAN 指定
1. WAN 中并不是都是物理地址，有些时软件定义，如 ATM 虚电路
拨号上网时是电话号?
1. LAN 或 WAN 内唯一

### IP地址


### 端口地址

1. 标识通信进程
1. 操作系统指定
1. 一台计算机内唯一
1. 传输层

### 目的地址

1. 单播(unicast)

1. 多播(multicast)
    链路层多播一定是符合：0x0100.5E
    网络层是:  224.
    本地级或全局级

1. 广播(broadcast)
    本地级


## TCP/IP版本

1. Version 4
1. Version 5
1. Version 6



中继器
    1. 放大器
    1. 信号再生器
        会剔除噪声

    缺点:
        引入延迟
        不具备检错/纠错能力
        不能适用于不通速度的以太网

网桥
    有两个口，网段指的就是一边，而不是三层的网段概念


路由器
    一种用于连接两个运行相同/不通协议的IS(中间系统)

网关
=======
路由器(覆盖下三层)
    一种用于连接两个运行相同/不通协议的IS(中间系统)

网关(覆盖整个7层)

    用于连接两个异构的相互独立的网络, 可以支持不通协议之间的转换。

    协议网关
        用于使用不通协议的网络之间进行协议转换

        链路层网关
            解决两种不通帧格式的网络之间的互联
        网络层网关
            完成不通网络层协议之间的转换，如 IPV4 和 IPV6 的转换
        
    应用网关
        用于不通格式之间翻译数据的系统, 如 EMAIL 网关
        POP
        X.400
        SMTP
        MHS

    安全网关(防火墙)

防火墙



路由选择
    非自适应算法(静态路由)
    自适应算法(动态路由)
        缺点
            路由决策复杂
            依赖于状态信息
            不能太快和太慢
        优点
            可提高网络性能
            有助于拥塞控制

路由算法的特性
    正确性
    简单性(减少开销)
    健壮性(网络中局部出现问题时，能避免跳坑)
    稳定性(不能来回翻摆)
    最优性(优先级的优化)
    公平性
    有效性(投入产出,路由等的维护与开销)

### 路由技术元素

性能标准
    1. 跳计数
    1. 成本
        与链路有关
        与数据率有关(数据率越高，成本越低)
        与当前排队延迟有关
    1. 延迟
    1. 吞吐量

网络信息源
    大多数路由决策要求根据网络拓扑，交通负载，链路成本等做出决定
    1. 无
    1. 局部
    1. 邻接节点
    1. 全部节点

信息更新时间
    1. 连续
    1. 定期
    1. 负载变化
    1. 拓扑变化

决策时间(路由表什么时候生成)
    1. 包(数据报)
        数据报到达时
        为每个包单独作路由决策
    1. 会晤(虚电路)
        虚电路建立时

决策地点
    1. 每个节点(分布)
        每个节点都负责位到达的包选择一条输出链路
    1. 中心节点(集中)
        由某些指定节点(如网络控制中心)负责决策
    1. 原始节点(源端)
        由源站点而非网络做出

自适应策略
    1. 故障
    1. 拥塞



### 静态路由算法

中心路由目录

    1 2 3 4 5 6
  1 -
  2   -
  3     -
  4       -
  5         -
  6           -


### 最短路径选择

最小跳数
最短距离
信道带宽
传输延迟
平均通信量

### 距离向量算法

#### DV算法的特点

1. 分布式的
    每个节点接收来自与其直接邻接节点的信息执行路由计算，将计算结果回传给直接邻接的节点

1. 迭代的
    计算过程循环进行，知道相邻节点没有可交换的信息位置

1. 异步的
    并不要求所有节点相互锁步操作




## 传输媒介

### 双绞线:    Twisted-pair cable

### 同轴电缆： Coaxial cable

### 光纤:      Fiber-optic cable

单模和多模光纤的区别是什么
    https://www.zhihu.com/question/40683684


### 非导向型介质

[3KHz,300GHz]



10Base-T 
    基带传输


## 交换

电路交换 circuit switching

报文交换 message switching
    要发送的整块数据成为一个“报文”。通过路由转发
    整个报文先传送到相邻节点，全部存储下来后查找转发表，转发到下一个节点

分组交换 packet switching
    数据报, Datagram
    虚电路, Virtual Circuit, VC


## 广域网

交换网络: 点对点式

    电路交换，分组交换

技术
    1. 


LAN vs. WAN

地理范围     LAN    WAN
延迟
速率
信道         广播   点对点
协议



## 特殊IP地址

分类标识 + 网络号 + 主机号

本网络上的特定主机: netid全部为零，主机位不为零
    基本上没有实现这个地址的通信方式

本网络上的本主机: 0.0.0.0


## 广播

直接广播: 标识特定网络中的所有主机

受限广播: 255.255.255.255

???这连个广播都是直接返回了，在另一个网段并没有抓到任何包

广播只可能是本地级别


路由器的一个接口可以有多个 IP


## 子网掩码速记

0    128    192   224    240    248    252    254   255
/0   /1     /2    /3     /4     /5     /6     /7    /8

超网只是针对C类网

合并超网的C类王个数Nc=2^n (n表示借了几位)

合并超网的C类王必须是连续的


192.168.0.0/24
192.168.1.0/24
192.168.2.0/24
192.168.3.0/24

192.168.0.0/22
借了2bit表示超网，2bit是2^2=4个C类网, 即超网范围是 192.168.0.X-192.168.3.X


使用超网技术减少路由表项的数目





## 交付和路由选择

Delivery 交付
    对分组的物理转发


Routing 路由选择，选路
    对分组寻找路由


route 路由，路径
routing 路由，路由选择，选路


## 面向连接和无连接服务/协议
	
            面向连接                                 无连接

通信过程    建立连接->交付分组->终止连接             交付分组

路由选择    仅在建立连接时选路                       每个分组独立选路

传输路径    相同                                     可以不同




## 直接交付和间接交付

直接交付
    分组目的与分组的**发送接口**在同一 IP 网络中
    同一个局域网中的计算机间是直接交付

间接交付
    分组目的与分组的**发送接口**在不同一 IP 网络中
    交付的第二阶段,路由器发送到目的主机是直接交付   





## 特定路由

主机路由
掩码值全为 1

作用: 
    1. 交付路径


默认路由
    目的网络地址: 0.0.0.0
    目的网络掩码: 0.0.0.0

作用:
    1. 减小路由表


## 静态和动态路由选择

静态路由选择				动态路由

1. 管理员手工设置			路由协议自动发现	
1. 管理员手工更新			路由协议自动更新
1. 不能保证路由的一致性和及时性		保证路由的一致性和及时性
1. 管理性强				管理性弱
1. 没有路由开销				产生一定的路由开销
1. 小型、变化缓慢网络			大型、迅速变化网络



## 路由表的构成过程

初始化阶段-路由发现

    推导初始路由
        直连网络 -> 直连路由

    无法推导部分
        手工设置 -> 静态路由
	路由器间交换选路信息 -> 动态路由


维护阶段-路由更新(网络拓扑更改时)
    手工、静态更新
    路由协议自动、动态更新


## 路由选择

从上到下依次执行，同 iptables

路由表表项的排列顺序
    直连路由
    主机路由
    网络路由
    默认路由

**从上到下，掩码值越来越少，即最长掩码匹配，优先查找较小的网络**



### IP

优先级: 对分组进行处理(排队或丢弃)的优先权，[0,7(网络控制，根据网络进行安排)], 未用

TOS: 该分组所**期望**的服务器质量

一般是通过应用层上进行控制的


RFC 2474
    DSCP(differentiated services code point)

为什么要有分组呢?
任何一个物理网络都有一个传输能力限制, 以太网一个帧最大时1518Bytes, 所以IP分组就要分割成可以
在以太网链路上进行传输的大小，这叫做分片


数据帧中的数据大小
+-------------------+-------+
|物理网             | MTU   |
+-------------------+-------+
|Token Ring(16Mbps) | 17914 | 
|Token Ring(4Mbps)  | 4464  |
|FDDI               | 4352  | 
|Ethernet           | 1500  | 
|X.25               | 576   | 
|PPP                | 296   | 
+-------------------+-------+

分片仅由路由器执行

确实需要时才进行分片: 提高传输效率
每个分片都要包含IP首部: 无连接通信
数据包可被多次分片


### 片偏移的例子

一个数据报total length:4020, 假设MTU是1420

需要分3个片
    1. [0,1399]   片偏移 0
        [0,1399]
    2. [0,1399]   片偏移 1400/8=175
        [1400,2799]
    3. [0,1399]   片偏移 2800/8=350
        [2800,3999]

片偏移的计算只考虑数据部分，不用考虑首部


TTL 为了防止路由环路，但是实验观察并没有出现TTL持续减1的流量，还是首先默认的icmp包
TTL 减1 比较是否为0


只校验首部，数据部分由高层协议校验
    无需重复校验数据部分
    缩短了路由器转发分组时的处理时间






Ethernet
FastEthernet
Giga











半双工只用了一对网线?
